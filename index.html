<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fora Conference Matching System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            padding: 2rem;
            color: #1e293b;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            padding: 3rem 2rem;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: url('https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=300&h=300&fit=crop&crop=center') center/cover;
            opacity: 0.1;
            border-radius: 50%;
            transform: translate(50px, -50px);
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 150px;
            height: 150px;
            background: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=300&h=300&fit=crop&crop=center') center/cover;
            opacity: 0.1;
            border-radius: 50%;
            transform: translate(-50px, 50px);
        }

        .header h1 {
            font-size: 2.75rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.125rem;
            color: #475569;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .algorithm-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            padding: 2.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .algorithm-section::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 120px;
            height: 120px;
            background: url('https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=200&h=200&fit=crop&crop=center') center/cover;
            opacity: 0.08;
            border-radius: 50%;
        }

        .algorithm-section h2 {
            color: #0f172a;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .algorithm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .algorithm-card {
            background: #ffffff;
            padding: 2rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .algorithm-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            opacity: 0.5;
            transform: translate(20px, -20px) rotate(45deg);
        }

        .algorithm-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }

        .algorithm-card h3 {
            color: #334155;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .algorithm-card p {
            color: #64748b;
            font-size: 0.9rem;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        .scoring-formula {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border: 1px solid #cbd5e1;
            padding: 1.5rem;
            margin-top: 1.5rem;
            font-family: 'Monaco', 'Consolas', monospace;
            color: #334155;
            text-align: center;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .main-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            padding: 2.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .main-card::before {
            content: '';
            position: absolute;
            bottom: -30px;
            left: -30px;
            width: 100px;
            height: 100px;
            background: url('https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200&h=200&fit=crop&crop=center') center/cover;
            opacity: 0.06;
            border-radius: 50%;
        }

        .upload-section {
            text-align: center;
            padding: 3rem;
            border: 2px dashed #cbd5e1;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .upload-section:hover {
            border-color: #94a3b8;
            background: #ffffff;
        }

        .upload-button {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            color: white;
            padding: 1rem 2rem;
            border: none;
            font-weight: 500;
            cursor: pointer;
            margin: 1rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.875rem;
        }

        .upload-button:hover {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .process-button {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 1.25rem 2.5rem;
            border: none;
            font-size: 1.125rem;
            font-weight: 500;
            cursor: pointer;
            display: block;
            margin: 2rem auto;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .process-button:hover {
            background: linear-gradient(135deg, #020617 0%, #0f172a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .process-button:disabled {
            background: linear-gradient(135deg, #94a3b8 0%, #cbd5e1 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            padding: 2.5rem 2rem;
            text-align: center;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -20px;
            right: -20px;
            width: 80px;
            height: 80px;
            background: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=100&h=100&fit=crop&crop=center') center/cover;
            opacity: 0.06;
            border-radius: 50%;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            border-color: #cbd5e1;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #0f172a;
            position: relative;
            z-index: 1;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }

        .matches-container {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            padding: 2rem;
            margin: 2rem 0;
            max-height: 500px;
            overflow-y: auto;
            position: relative;
        }

        .matches-container::before {
            content: '';
            position: absolute;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: url('https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=100&h=100&fit=crop&crop=center') center/cover;
            opacity: 0.05;
            border-radius: 50%;
        }

        .match-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.75rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .match-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #334155 0%, #64748b 100%);
            opacity: 0.7;
        }

        .match-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }

        .advisor-info {
            font-weight: 500;
            color: #0f172a;
            font-size: 1.05rem;
        }

        .conference-location {
            color: #64748b;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .advisor-notes {
            color: #94a3b8;
            font-size: 0.75rem;
            font-style: italic;
            margin-top: 0.5rem;
            max-width: 400px;
        }

        .ttv-info {
            text-align: right;
            font-size: 0.875rem;
        }

        .ttv-amount {
            color: #0f172a;
            font-weight: 600;
            font-size: 1rem;
        }

        .preference-rank {
            color: #64748b;
            margin: 0.25rem 0;
        }

        .score-badge {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #334155;
            padding: 0.375rem 0.75rem;
            margin-top: 0.5rem;
            border: 1px solid #cbd5e1;
            display: inline-block;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .download-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 3rem;
        }

        .download-button {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.875rem;
        }

        .download-button:hover {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #334155;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 3rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .debug-info {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 1px solid #f59e0b;
            padding: 1.25rem;
            margin: 1rem 0;
            font-size: 0.875rem;
            color: #92400e;
        }

        @media (max-width: 768px) {
            .algorithm-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .download-section {
                grid-template-columns: 1fr;
            }
            .match-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Fora Conference Matching System</h1>
            <p>Intelligent advisor-conference optimization platform</p>
        </div>

        <div class="algorithm-section">
            <h2>🧠 How Our Matching Algorithm Works</h2>
            <div class="algorithm-grid">
                <div class="algorithm-card">
                    <h3>Business Priority (40%)</h3>
                    <p>Advisors with higher Total Travel Value (TTV) receive priority placement. This ensures our most valuable advisors get first choice at premium conferences.</p>
                </div>
                <div class="algorithm-card">
                    <h3>Preference Matching (35%)</h3>
                    <p>Your ranked preferences (1-5) are heavily weighted. We prioritize matching you to conferences you specifically requested and ranked highly.</p>
                </div>
                <div class="algorithm-card">
                    <h3>Qualification Requirements (25%)</h3>
                    <p>Geographic TTV thresholds, experience levels, and repeat attendance rules ensure all matches meet conference partner requirements.</p>
                </div>
            </div>
            <div class="scoring-formula">
                Final Score = (Business Priority × 0.4) + (Preference Score × 0.35) + (Qualification Match × 0.25)
            </div>
        </div>

        <div class="main-card">
            <div id="upload-step">
                <div class="upload-section">
                    <h3>Upload Your Data</h3>
                    <p>Choose your preferred data format</p>
                    
                    <!-- Multiple upload options -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0;">
                        <div style="text-align: center; padding: 1.5rem; border: 1px solid #cbd5e1; background: #ffffff;">
                            <h4 style="color: #334155; margin-bottom: 0.5rem;">📄 CSV Upload</h4>
                            <p style="font-size: 0.875rem; color: #64748b; margin-bottom: 1rem;">Simple CSV format</p>
                            <input type="file" id="csv-input" accept=".csv" style="display: none;">
                            <button class="upload-button" onclick="document.getElementById('csv-input').click()">
                                Upload CSV
                            </button>
                        </div>
                        
                        <div style="text-align: center; padding: 1.5rem; border: 1px solid #cbd5e1; background: #ffffff;">
                            <h4 style="color: #334155; margin-bottom: 0.5rem;">📊 Excel Upload</h4>
                            <p style="font-size: 0.875rem; color: #64748b; margin-bottom: 1rem;">Full Excel file</p>
                            <input type="file" id="excel-input" accept=".xlsx,.xls" style="display: none;">
                            <button class="upload-button" onclick="document.getElementById('excel-input').click()">
                                Upload Excel
                            </button>
                        </div>
                        
                        <div style="text-align: center; padding: 1.5rem; border: 1px solid #cbd5e1; background: #ffffff;">
                            <h4 style="color: #334155; margin-bottom: 0.5rem;">✏️ Manual Entry</h4>
                            <p style="font-size: 0.875rem; color: #64748b; margin-bottom: 1rem;">Paste your data</p>
                            <button class="upload-button" onclick="showManualEntry()">
                                Enter Data
                            </button>
                        </div>
                    </div>
                    
                    <div id="file-status"></div>
                    <div id="debug-info" class="debug-info" style="display: none;"></div>
                    
                    <!-- Manual data entry area -->
                    <div id="manual-entry" style="display: none; margin-top: 2rem; text-align: left;">
                        <h4 style="margin-bottom: 1rem;">📝 Paste Your Advisor Data</h4>
                        <p style="font-size: 0.875rem; color: #64748b; margin-bottom: 1rem;">
                            Format: Advisor ID, Conference Preference 1, Conference Preference 2, TTV, Previous Conference<br>
                            Example: 3045, ILTM Cannes, LE Miami, 4078938, None
                        </p>
                        <textarea 
                            id="manual-data" 
                            placeholder="3045, ILTM Cannes, LE Miami, 4078938, None
2463, ILTM Americas, DUCO Italy, 3449979, None
6841, LE Miami, Do Not Disturb, 2657344, ILTM Cannes"
                            style="width: 100%; height: 200px; padding: 1rem; border: 1px solid #cbd5e1; font-family: monospace; font-size: 0.875rem;"
                        ></textarea>
                        <button onclick="processManualData()" class="upload-button" style="margin-top: 1rem;">
                            Process Data
                        </button>
                    </div>
                    
                    <!-- Sample data option -->
                    <div style="margin-top: 2rem; padding: 1rem; background: #f1f5f9; border: 1px solid #cbd5e1;">
                        <p style="font-size: 0.875rem; color: #475569; margin-bottom: 0.5rem;">
                            <strong>🚀 Want to test the system?</strong>
                        </p>
                        <button onclick="loadSampleData()" class="upload-button" style="background: linear-gradient(135deg, #475569 0%, #64748b 100%);">
                            Load Sample Data
                        </button>
                    </div>
                </div>
                <button class="process-button" id="process-btn" onclick="runMatching()" disabled>
                    Upload Data First
                </button>
            </div>

            <div id="processing-step" class="hidden">
                <div style="text-align: center;">
                    <div class="spinner"></div>
                    <h3>Running Real Matching Algorithm</h3>
                    <p>Processing your actual advisor preferences and TTV data...</p>
                    <div id="processing-status"></div>
                </div>
            </div>

            <div id="results-step" class="hidden">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 id="results-title">Matches Generated</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="pref-stat">--%</div>
                            <div class="stat-label">Top 3 Preferences</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="ttv-stat">$--M</div>
                            <div class="stat-label">Total TTV Matched</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="qual-stat">--%</div>
                            <div class="stat-label">Eligible Matches</div>
                        </div>
                    </div>
                </div>

                <h3>Your Matches:</h3>
                <div class="matches-container" id="matches-list">
                    <!-- Real matches will be populated here -->
                </div>

                <div class="download-section">
                    <button class="download-button" onclick="downloadMatches()">
                        📄 Download Match Results
                    </button>
                    <button class="download-button" onclick="downloadEmails()">
                        📧 Download Email Templates
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let fileData = null;
        let realMatches = [];

        // Complete conference database with all details
        const conferenceDatabase = {
            "DUCO Italy": { location: "Milan, Italy", dates: "Mar 23–27, 2026", description: "Exclusive Italy-focused conference for advisors with significant Italian market expertise." },
            "DUCO Portugal/Spain": { location: "Marbella, Spain", dates: "Oct 19–23, 2026", description: "Iberian Peninsula conference for advisors with significant Spain and Portugal market presence." },
            "DUCO Spain/Portugal": { location: "Marbella, Spain", dates: "Oct 19–23, 2026", description: "Iberian Peninsula conference for advisors with significant Spain and Portugal market presence." },
            "DUCO France": { location: "Paris, France", dates: "Nov 2–6, 2026", description: "Exclusive French market conference for advisors with substantial France booking volume." },
            "Emotions Latin America & Car": { location: "Costa Rica", dates: "Mar 8–11, 2026", description: "Central and South American travel showcase emphasizing adventure and eco-luxury." },
            "Emotions Latin America": { location: "Costa Rica", dates: "Mar 8–11, 2026", description: "Central and South American travel showcase emphasizing adventure and eco-luxury." },
            "Emotions Europe": { location: "Madrid, Spain", dates: "May 15–18, 2026", description: "European travel specialization conference featuring cultural immersion experiences." },
            "Emotions Madrid": { location: "Madrid, Spain", dates: "Jun 1–4, 2026", description: "Spanish mainland cultural conference focusing on art, cuisine, and luxury city experiences." },
            "Emotions: Balearics": { location: "Mallorca, Spain", dates: "May 28–31, 2026", description: "Luxury Balearic Islands conference featuring exclusive resorts and yacht experiences." },
            "Emotions: Greece": { location: "Santorini, Greece", dates: "Jun 5–8, 2026", description: "Greek island luxury travel conference featuring yacht charters and villa experiences." },
            "ILTM Americas": { location: "Mexico City, Mexico", dates: "Sep 2–5, 2025", description: "Premier luxury travel event for the Americas connecting regional specialists." },
            "ILTM Cannes": { location: "Cannes, France", dates: "Dec 1–4, 2025", description: "World's leading luxury travel trade show with exclusive networking opportunities." },
            "Remote Immersion": { location: "Iceland", dates: "Aug 12–15, 2026", description: "Specializing in off-the-beaten-path and adventure travel destinations." },
            "Further East": { location: "Singapore", dates: "Oct 5–8, 2026", description: "Asia-Pacific travel conference focusing on emerging destinations and luxury experiences." },
            "We Are Africa": { location: "Cape Town, South Africa", dates: "Jul 8–11, 2026", description: "Definitive African travel showcase connecting advisors with authentic safari experiences." },
            "WAA Sundance": { location: "Park City, Utah", dates: "Jan 20–23, 2026", description: "Winter luxury travel conference coinciding with Sundance Film Festival." },
            "LE Miami": { location: "Miami, FL", dates: "Feb 10–13, 2026", description: "Luxury Exchange Miami for influential luxury travel advisors and suppliers." },
            "PURE Life Experiences": { location: "Swiss Alps", dates: "Nov 18–21, 2026", description: "Focusing on experiential and transformative luxury travel experiences." },
            "Do Not Disturb": { location: "Portugal", dates: "Apr 20–23, 2026", description: "Exclusive wellness and retreat-focused conference for transformative travel." },
            "TRUE Sicily": { location: "Sicily, Italy", dates: "Jun 14–17, 2026", description: "Intimate conference showcasing authentic Sicilian culture and cuisine." },
            "TRUE Dolomites": { location: "Italian Alps", dates: "Sep 15–18, 2026", description: "Mountain luxury and alpine adventure conference in Italy's Dolomites." },
            "TRUE Puglia": { location: "Puglia, Italy", dates: "Apr 12–15, 2026", description: "Southern Italian cultural and culinary conference showcasing Puglia's charm." }
        };

        // Multiple data input handlers
        
        // Simple CSV handler
        document.addEventListener('DOMContentLoaded', function() {
            // CSV Upload
            const csvInput = document.getElementById('csv-input');
            if (csvInput) {
                csvInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const csvData = event.target.result;
                            processCSVData(csvData, file.name);
                        } catch (error) {
                            showError('Error reading CSV file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                });
            }

            // Excel Upload (simplified)
            const excelInput = document.getElementById('excel-input');
            if (excelInput) {
                excelInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    showStatus('📄 Processing Excel file (this may take a moment)...', 'info');
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            if (typeof XLSX === 'undefined') {
                                showError('Excel processing not available. Please use CSV format instead.');
                                return;
                            }
                            
                            const data = new Uint8Array(event.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});
                            processExcelDataSimple(workbook, file.name);
                        } catch (error) {
                            showError('Error reading Excel file. Try converting to CSV format: ' + error.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            }
        });

        // Simple CSV processor
        function processCSVData(csvText, filename) {
            console.log('📊 Processing CSV data...');
            
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            console.log('CSV Headers:', headers);
            
            const advisors = [];
            const ttvData = {};
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                
                if (values.length >= 4) {
                    const advisorId = parseInt(values[0]);
                    const ttv = parseFloat(values[3]) || 0;
                    
                    if (advisorId && !isNaN(advisorId)) {
                        const advisor = {
                            id: advisorId,
                            preferences: [],
                            previousConference: values[4] && values[4] !== 'None' ? values[4] : null,
                            notes: values[5] || ''
                        };
                        
                        // Add preferences
                        if (values[1] && values[1] !== '') {
                            advisor.preferences.push({ conference: values[1], ranking: 1 });
                        }
                        if (values[2] && values[2] !== '') {
                            advisor.preferences.push({ conference: values[2], ranking: 2 });
                        }
                        
                        advisors.push(advisor);
                        ttvData[advisorId] = ttv;
                    }
                }
            }
            
            if (advisors.length === 0) {
                showError('No valid advisor data found in CSV');
                return;
            }
            
            fileData = {
                advisors: advisors,
                ttv: ttvData,
                geo: {},
                conferences: []
            };
            
            showSuccess(`✅ Processed ${advisors.length} advisors from ${filename}`);
            enableProcessing();
        }

        // Manual data entry
        function showManualEntry() {
            document.getElementById('manual-entry').style.display = 'block';
        }

        function processManualData() {
            const textData = document.getElementById('manual-data').value.trim();
            if (!textData) {
                showError('Please enter some data first');
                return;
            }
            
            try {
                processCSVData(textData, 'manual entry');
            } catch (error) {
                showError('Error processing manual data: ' + error.message);
            }
        }

        // Load sample data for testing
        function loadSampleData() {
            const sampleData = `Advisor ID,Conference 1,Conference 2,TTV,Previous Conference,Notes
3045,ILTM Cannes,LE Miami,4078938,None,Luxury specialist
2463,ILTM Americas,DUCO Italy,3449979,None,High-volume Americas advisor
6841,LE Miami,Do Not Disturb,2657344,ILTM Cannes,Strong luxury leisure focus
9236,LE Miami,ILTM Cannes,1753868,None,Can't travel Feb-June
11508,ILTM Cannes,ILTM Americas,2845192,None,European specialist
8394,Do Not Disturb,Emotions Europe,1892456,None,Wellness specialist
5750,Emotions Europe,LE Miami,1634729,None,European market focus
7821,ILTM Americas,We Are Africa,1567843,None,Americas specialist
4392,We Are Africa,ILTM Americas,1438291,None,Africa safari expert
6321,LE Miami,ILTM Cannes,1329847,None,Luxury beach specialist`;
            
            processCSVData(sampleData, 'sample data');
        }

        // Simplified Excel processor (fallback)
        function processExcelDataSimple(workbook, filename) {
            try {
                console.log('📋 Available sheets:', workbook.SheetNames);
                
                // Try to find advisor data in any sheet
                let advisorData = null;
                let ttvData = {};
                
                // Look for advisor preferences
                for (const sheetName of workbook.SheetNames) {
                    if (sheetName.toLowerCase().includes('advisor') || sheetName.toLowerCase().includes('preference')) {
                        const sheet = workbook.Sheets[sheetName];
                        advisorData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        console.log(`Found advisor data in sheet: ${sheetName}`);
                        break;
                    }
                }
                
                if (!advisorData) {
                    showError('No advisor data sheet found. Please use CSV format or check sheet names.');
                    return;
                }
                
                // Process the data
                const headers = advisorData[0];
                const rows = advisorData.slice(1);
                
                const advisors = [];
                
                for (const row of rows) {
                    if (!row[1]) continue; // Skip empty rows
                    
                    const advisorId = parseInt(row[1]);
                    if (!advisorId) continue;
                    
                    const advisor = {
                        id: advisorId,
                        preferences: [],
                        previousConference: row[2] === 'None!' ? null : row[2],
                        notes: row[25] || ''
                    };
                    
                    // Extract preferences from columns
                    for (let i = 3; i <= 21; i++) {
                        if (headers[i] && typeof row[i] === 'number' && row[i] >= 1 && row[i] <= 5) {
                            advisor.preferences.push({
                                conference: headers[i],
                                ranking: row[i]
                            });
                        }
                    }
                    
                    advisor.preferences.sort((a, b) => a.ranking - b.ranking);
                    
                    if (advisor.preferences.length > 0) {
                        advisors.push(advisor);
                        ttvData[advisorId] = 1000000; // Default TTV if not provided
                    }
                }
                
                if (advisors.length === 0) {
                    showError('No valid advisors with preferences found');
                    return;
                }
                
                fileData = {
                    advisors: advisors,
                    ttv: ttvData,
                    geo: {},
                    conferences: []
                };
                
                showSuccess(`✅ Processed ${advisors.length} advisors from ${filename}`);
                enableProcessing();
                
            } catch (error) {
                showError('Error processing Excel file: ' + error.message);
            }
        }

        // Helper functions
        function showStatus(message, type = 'info') {
            const colors = {
                info: { bg: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)', border: '#3b82f6', text: '#1e40af' },
                error: { bg: 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)', border: '#dc2626', text: '#dc2626' },
                success: { bg: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)', border: '#10b981', text: '#065f46' }
            };
            
            const color = colors[type];
            document.getElementById('file-status').innerHTML = `
                <div style="background: ${color.bg}; padding: 1.25rem; margin-top: 1rem; border: 1px solid ${color.border};">
                    <p style="color: ${color.text}; font-weight: 500;">${message}</p>
                </div>
            `;
        }

        function showError(message) {
            showStatus('❌ ' + message, 'error');
        }

        function showSuccess(message) {
            showStatus(message, 'success');
        }

        function enableProcessing() {
            const processBtn = document.getElementById('process-btn');
            processBtn.disabled = false;
            processBtn.textContent = '🚀 Generate Optimized Matches';
            processBtn.style.background = 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)';
            processBtn.style.cursor = 'pointer';
        }

        function processExcelData(workbook) {
            try {
                const debugInfo = document.getElementById('debug-info');
                debugInfo.style.display = 'block';
                
                // Get sheet names
                const sheetNames = workbook.SheetNames;
                debugInfo.innerHTML = `<strong>Sheets found:</strong> ${sheetNames.join(', ')}`;
                
                // Process advisor preferences
                const advisorSheet = workbook.Sheets['Advisor Preferences'];
                if (!advisorSheet) {
                    throw new Error('Advisor Preferences sheet not found');
                }
                
                const advisorData = XLSX.utils.sheet_to_json(advisorSheet, { header: 1 });
                const headers = advisorData[0];
                const rows = advisorData.slice(1);
                
                // Process TTV data
                const ttvSheet = workbook.Sheets['Advisor 12 month trailing TTV'];
                const ttvData = ttvSheet ? XLSX.utils.sheet_to_json(ttvSheet) : [];
                
                // Process geo data
                const geoSheet = workbook.Sheets['Geo Values'];
                const geoData = geoSheet ? XLSX.utils.sheet_to_json(geoSheet) : [];
                
                // Process conference data
                const confSheet = workbook.Sheets['Conference Spots'];
                const confData = confSheet ? XLSX.utils.sheet_to_json(confSheet) : [];
                
                // Create data structures
                fileData = {
                    advisors: processAdvisors(headers, rows),
                    ttv: createTTVMap(ttvData),
                    geo: createGeoMap(geoData),
                    conferences: confData
                };
                
                debugInfo.innerHTML += `<br><strong>Processed:</strong> ${fileData.advisors.length} advisors, ${Object.keys(fileData.ttv).length} TTV records, ${confData.length} conferences`;
                
                // Enable the process button
                const processBtn = document.getElementById('process-btn');
                processBtn.disabled = false;
                processBtn.textContent = 'Generate Real Matches';
                processBtn.style.background = '#28a745';
                
                document.getElementById('file-status').innerHTML = `
                    <div style="background: #d1fae5; padding: 1rem; margin-top: 1rem; border: 1px solid #10b981;">
                        <p style="color: #065f46; font-weight: 500;">✓ File processed successfully!</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error processing Excel data:', error);
                document.getElementById('file-status').innerHTML = `
                    <div style="background: #f8d7da; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; border: 1px solid #dc3545;">
                        <p style="color: #dc3545; font-weight: 600;">❌ Error processing file: ${error.message}</p>
                    </div>
                `;
            }
        }

        function processAdvisors(headers, rows) {
            const advisors = [];
            
            rows.forEach(row => {
                if (!row[1]) return; // Skip empty advisor ID
                
                const advisor = {
                    id: row[1],
                    previousConference: row[2] === 'None!' ? null : row[2],
                    preferences: [],
                    notes: row[25] || ''
                };
                
                // Extract preferences from columns 3-21
                for (let i = 3; i <= 21; i++) {
                    if (headers[i] && typeof row[i] === 'number' && row[i] >= 1 && row[i] <= 5) {
                        advisor.preferences.push({
                            conference: headers[i],
                            ranking: row[i]
                        });
                    }
                }
                
                advisor.preferences.sort((a, b) => a.ranking - b.ranking);
                advisors.push(advisor);
            });
            
            return advisors;
        }

        function createTTVMap(ttvData) {
            const ttvMap = {};
            ttvData.forEach(record => {
                if (record['Advisor ID']) {
                    ttvMap[record['Advisor ID']] = record['Commissionable Booking Value (12 Months)'] || 0;
                }
            });
            return ttvMap;
        }

        function createGeoMap(geoData) {
            const geoMap = {};
            geoData.forEach(record => {
                if (record['Advisor ID']) {
                    const id = record['Advisor ID'];
                    if (!geoMap[id]) geoMap[id] = {};
                    const country = record.Country;
                    const value = record['Commissionable Booking Value'] || 0;
                    if (!geoMap[id][country]) geoMap[id][country] = 0;
                    geoMap[id][country] += value;
                }
            });
            return geoMap;
        }

        function runMatching() {
            if (!fileData) {
                alert('⚠️  Please upload your Excel file first');
                return;
            }
            
            console.log('🎯 Starting matching process...');
            
            // Show processing with better feedback
            document.getElementById('upload-step').classList.add('hidden');
            document.getElementById('processing-step').classList.remove('hidden');
            
            const statusDiv = document.getElementById('processing-status');
            statusDiv.innerHTML = '<p style="color: #334155;">🔄 Initializing matching algorithm...</p>';
            
            // Simulate realistic processing time with status updates
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                if (progress <= 30) {
                    statusDiv.innerHTML = '<p style="color: #334155;">📊 Analyzing advisor preferences and TTV data...</p>';
                } else if (progress <= 60) {
                    statusDiv.innerHTML = '<p style="color: #334155;">🎯 Running optimization algorithm...</p>';
                } else if (progress <= 90) {
                    statusDiv.innerHTML = '<p style="color: #334155;">✅ Generating matches and checking eligibility...</p>';
                }
            }, 200);
            
            // Run the actual matching algorithm after delay
            setTimeout(() => {
                clearInterval(progressInterval);
                try {
                    console.log('⚡ Executing matching algorithm...');
                    realMatches = runRealMatchingAlgorithm(fileData);
                    console.log('🎉 Matching completed successfully!');
                    showRealResults();
                } catch (error) {
                    console.error('❌ Matching algorithm error:', error);
                    statusDiv.innerHTML = `<p style="color: #dc2626;">❌ Error: ${error.message}</p>`;
                    
                    // Show error state
                    setTimeout(() => {
                        document.getElementById('processing-step').classList.add('hidden');
                        document.getElementById('upload-step').classList.remove('hidden');
                        alert('Error running matching algorithm. Please check the console and try again.');
                    }, 2000);
                }
            }, 3000);
        }

        function runRealMatchingAlgorithm(data) {
            const { advisors, ttv, geo, conferences } = data;
            
            console.log('🚀 Starting optimized matching algorithm...');
            console.log('📊 Data summary:', { 
                advisorCount: advisors.length, 
                ttvCount: Object.keys(ttv).length, 
                confCount: conferences.length 
            });
            
            // Optimize: Pre-filter and enrich advisors
            const enrichedAdvisors = advisors
                .filter(advisor => {
                    // Must have advisor ID, TTV data, and at least one preference
                    return advisor.id && ttv[advisor.id] && advisor.preferences && advisor.preferences.length > 0;
                })
                .map(advisor => ({
                    ...advisor,
                    totalTTV: ttv[advisor.id] || 0,
                    geoTTV: geo[advisor.id] || {},
                    // Pre-calculate advisor tier for faster processing
                    tier: ttv[advisor.id] >= 2000000 ? 'premium' : 
                          ttv[advisor.id] >= 1000000 ? 'professional' : 'rising'
                }))
                // Optimize: Sort by TTV descending for business priority
                .sort((a, b) => b.totalTTV - a.totalTTV);
            
            console.log(`✅ Processed ${enrichedAdvisors.length} eligible advisors`);
            
            // Optimize: Build efficient conference lookup
            const requestedConferences = new Set();
            const conferenceRequestCounts = {};
            
            // Analyze demand patterns
            enrichedAdvisors.forEach(advisor => {
                advisor.preferences.forEach(pref => {
                    requestedConferences.add(pref.conference);
                    conferenceRequestCounts[pref.conference] = (conferenceRequestCounts[pref.conference] || 0) + 1;
                });
            });
            
            // Initialize optimized conference data structure
            const conferenceCapacity = {};
            const availableConferences = [];
            
            requestedConferences.forEach(confName => {
                const confData = conferences.find(c => c.Conference === confName);
                const dbData = conferenceDatabase[confName];
                
                // Smart capacity allocation based on demand
                const baseCapacity = confData ? (confData.Capacity || 6) : 6;
                const demand = conferenceRequestCounts[confName] || 0;
                const adjustedCapacity = Math.min(baseCapacity, Math.max(1, Math.ceil(demand * 0.3))); // Cap at 30% of demand or base capacity
                
                conferenceCapacity[confName] = adjustedCapacity;
                availableConferences.push({
                    Conference: confName,
                    Location: dbData ? dbData.location : (confData ? confData.Location : 'Location TBD'),
                    Dates: dbData ? dbData.dates : 'Dates TBD',
                    Capacity: adjustedCapacity,
                    Demand: demand,
                    CompetitiveRatio: demand / adjustedCapacity
                });
            });
            
            // Sort conferences by competitive ratio for strategic allocation
            availableConferences.sort((a, b) => b.CompetitiveRatio - a.CompetitiveRatio);
            
            console.log('🎯 Conference demand analysis:', 
                availableConferences.map(c => `${c.Conference}: ${c.Demand} requests, ${c.Capacity} spots (${c.CompetitiveRatio.toFixed(1)}x)`).join('\n')
            );
            
            const matches = [];
            const unmatchedAdvisors = [];
            const matchingLog = [];
            
            // Optimized matching algorithm with strategic allocation
            for (const advisor of enrichedAdvisors) {
                if (matches.length >= 25) break;
                
                let bestMatch = null;
                let bestScore = -1;
                const attemptedMatches = [];
                
                // Process preferences in order (1st choice first)
                for (const preference of advisor.preferences) {
                    const confName = preference.conference;
                    
                    if (conferenceCapacity[confName] <= 0) {
                        attemptedMatches.push(`${confName}: No capacity`);
                        continue;
                    }
                    
                    const conference = availableConferences.find(c => c.Conference === confName);
                    if (!conference) {
                        attemptedMatches.push(`${confName}: Not found`);
                        continue;
                    }
                    
                    const score = calculateRealMatchScore(advisor, conference, preference.ranking);
                    attemptedMatches.push(`${confName}: Score ${score.total.toFixed(1)}, Eligible: ${score.eligible}`);
                    
                    if (score.eligible && score.total > bestScore) {
                        bestMatch = {
                            advisor,
                            conference,
                            score,
                            preferenceRank: preference.ranking
                        };
                        bestScore = score.total;
                    }
                }
                
                if (bestMatch) {
                    matches.push(bestMatch);
                    conferenceCapacity[bestMatch.conference.Conference]--;
                    
                    matchingLog.push(`✅ Advisor ${advisor.id} (${advisor.tier}, ${advisor.totalTTV.toLocaleString()}) → ${bestMatch.conference.Conference} (Pref #${bestMatch.preferenceRank}, Score: ${bestScore.toFixed(1)})`);
                } else {
                    unmatchedAdvisors.push(advisor);
                    matchingLog.push(`❌ Advisor ${advisor.id} (${advisor.tier}, ${advisor.totalTTV.toLocaleString()}) - No eligible matches. Attempted: ${attemptedMatches.join(', ')}`);
                }
            }
            
            console.log('📋 Matching Results:\n' + matchingLog.slice(0, 10).join('\n'));
            console.log(`\n🎉 Final Results: ${matches.length} matches, ${unmatchedAdvisors.length} unmatched`);
            
            // Calculate success metrics
            const totalMatchedTTV = matches.reduce((sum, m) => sum + m.advisor.totalTTV, 0);
            const topPrefMatches = matches.filter(m => m.preferenceRank <= 3).length;
            const avgScore = matches.reduce((sum, m) => sum + m.score.total, 0) / matches.length;
            
            console.log(`💰 Total TTV Matched: ${totalMatchedTTV.toLocaleString()}`);
            console.log(`🎯 Top-3 Preference Rate: ${((topPrefMatches / matches.length) * 100).toFixed(1)}%`);
            console.log(`📊 Average Match Score: ${avgScore.toFixed(1)}/100`);
            
            return matches;
        }

        function calculateRealMatchScore(advisor, conference, preferenceRank) {
            // Business priority (40% weight) - based on TTV
            const businessPriority = Math.min(advisor.totalTTV / 2000000, 1.0) * 100 * 0.4;
            
            // Preference score (35% weight) - higher score for better ranking
            const preferenceScore = preferenceRank ? (6 - preferenceRank) * 20 * 0.35 : 0;
            
            // Check eligibility
            const eligibility = checkRealEligibility(advisor, conference);
            const qualificationScore = eligibility.eligible ? 100 * 0.25 : 0;
            
            return {
                total: businessPriority + preferenceScore + qualificationScore,
                business: businessPriority,
                preference: preferenceScore,
                qualification: qualificationScore,
                eligible: eligibility.eligible,
                reason: eligibility.reason,
                preferenceRank: preferenceRank
            };
        }

        function checkRealEligibility(advisor, conference) {
            const conf = conference.Conference;
            
            // Enhanced repeat attendance checking - look for conference names in previous attendance
            if (advisor.previousConference && advisor.previousConference !== 'None!' && advisor.previousConference.toLowerCase() !== 'none') {
                const prevConf = advisor.previousConference.toLowerCase();
                const currentConf = conf.toLowerCase();
                
                // Check for exact match
                if (prevConf === currentConf) {
                    return { eligible: false, reason: 'Attended same conference last year' };
                }
                
                // Check for conference family matches (e.g., "DUCO Italy" and "DUCO France" are same family)
                if (prevConf.includes('duco') && currentConf.includes('duco')) {
                    return { eligible: false, reason: 'Attended DUCO family conference last year' };
                }
                
                if (prevConf.includes('iltm') && currentConf.includes('iltm')) {
                    return { eligible: false, reason: 'Attended ILTM family conference last year' };
                }
                
                if (prevConf.includes('emotions') && currentConf.includes('emotions')) {
                    return { eligible: false, reason: 'Attended Emotions family conference last year' };
                }
                
                if (prevConf.includes('true') && currentConf.includes('true')) {
                    return { eligible: false, reason: 'Attended TRUE family conference last year' };
                }
            }
            
            // Parse notes for additional attendance history
            if (advisor.notes) {
                const notes = advisor.notes.toLowerCase();
                const currentConf = conf.toLowerCase();
                
                // Check if notes mention attending this conference recently
                if (notes.includes(currentConf) && (notes.includes('attended') || notes.includes('went to') || notes.includes('2024') || notes.includes('2023'))) {
                    return { eligible: false, reason: 'Recent attendance mentioned in notes' };
                }
            }
            
            // Geographic and TTV requirements
            if (conf === 'DUCO Italy') {
                const italyTTV = advisor.geoTTV['Italy'] || 0;
                if (italyTTV < 200000) {
                    return { eligible: false, reason: `Italy TTV: ${italyTTV.toLocaleString()} < $200k required` };
                }
            }
            
            if (conf === 'DUCO France') {
                const franceTTV = advisor.geoTTV['France'] || 0;
                if (franceTTV < 200000) {
                    return { eligible: false, reason: `France TTV: ${franceTTV.toLocaleString()} < $200k required` };
                }
            }
            
            if (conf === 'DUCO Spain/Portugal' || conf === 'DUCO Portugal/Spain') {
                const spainTTV = (advisor.geoTTV['Spain'] || 0) + (advisor.geoTTV['Portugal'] || 0);
                if (spainTTV < 200000) {
                    return { eligible: false, reason: `Iberia TTV: ${spainTTV.toLocaleString()} < $200k required` };
                }
            }
            
            // Premium conference TTV requirements
            if (conf === 'ILTM Cannes' && advisor.totalTTV < 2000000) {
                return { eligible: false, reason: `Total TTV: ${advisor.totalTTV.toLocaleString()} < $2M required` };
            }
            
            if (conf === 'ILTM Americas' && advisor.totalTTV < 1500000) {
                return { eligible: false, reason: `Total TTV: ${advisor.totalTTV.toLocaleString()} < $1.5M recommended` };
            }
            
            // Experience and tier requirements
            if (advisor.totalTTV < 100000) {
                const premiumConferences = ['ILTM Cannes', 'ILTM Americas', 'LE Miami', 'Do Not Disturb'];
                if (premiumConferences.includes(conf)) {
                    return { eligible: false, reason: `Minimum $100k TTV required for premium conferences` };
                }
            }
            
            return { eligible: true, reason: 'Meets all requirements' };
        }

        function showRealResults() {
            document.getElementById('processing-step').classList.add('hidden');
            document.getElementById('results-step').classList.remove('hidden');
            
            // Update stats
            const totalTTV = realMatches.reduce((sum, match) => sum + match.advisor.totalTTV, 0);
            const topPrefCount = realMatches.filter(match => match.preferenceRank && match.preferenceRank <= 3).length;
            const eligibleCount = realMatches.filter(match => match.score.eligible).length;
            
            document.getElementById('results-title').textContent = `${realMatches.length} Matches Generated`;
            document.getElementById('pref-stat').textContent = realMatches.length > 0 ? `${Math.round((topPrefCount / realMatches.length) * 100)}%` : '0%';
            document.getElementById('ttv-stat').textContent = `${Math.round(totalTTV / 1000000)}M`;
            document.getElementById('qual-stat').textContent = realMatches.length > 0 ? `${Math.round((eligibleCount / realMatches.length) * 100)}%` : '0%';
            
            // Populate matches
            const matchesList = document.getElementById('matches-list');
            if (realMatches.length === 0) {
                matchesList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        <p>No matches found. This might be due to:</p>
                        <ul style="text-align: left; margin-top: 1rem;">
                            <li>Missing TTV data for advisors</li>
                            <li>No advisor preferences found</li>
                            <li>All advisors already attended their preferred conferences</li>
                        </ul>
                        <p style="margin-top: 1rem;">Check the debug info above for more details.</p>
                    </div>
                `;
                return;
            }
            
            matchesList.innerHTML = realMatches.map((match, i) => {
                const dbData = conferenceDatabase[match.conference.Conference];
                const location = dbData ? dbData.location : (match.conference.Location || 'Location TBD');
                const dates = dbData ? dbData.dates : 'Dates TBD';
                
                return `
                    <div class="match-item">
                        <div style="flex: 1;">
                            <div class="advisor-info">#${i + 1} Advisor ${match.advisor.id} → ${match.conference.Conference}</div>
                            <div class="conference-location">${location} • ${dates}</div>
                            ${match.advisor.notes ? `<div class="advisor-notes">${match.advisor.notes.substring(0, 80)}...</div>` : ''}
                        </div>
                        <div class="ttv-info">
                            <div class="ttv-amount">${match.advisor.totalTTV.toLocaleString()}</div>
                            <div class="preference-rank">${match.preferenceRank ? `#${match.preferenceRank} preference` : 'Not ranked'}</div>
                            <div class="score-badge">
                                Score: ${Math.round(match.score.total)}/100
                            </div>
                        </div>
                    </div>
                `;
            }).join('');.advisor.notes ? `<div style="color: #6c757d; font-size: 0.75rem; font-style: italic;">${match.advisor.notes.substring(0, 60)}...</div>` : ''}
                        </div>
                        <div class="ttv-info">
                            <div>${match.advisor.totalTTV.toLocaleString()}</div>
                            <div>${match.preferenceRank ? `#${match.preferenceRank} preference` : 'Not ranked'}</div>
                            <div style="background: #f3f4f6; color: #374151; padding: 0.25rem 0.5rem; margin-top: 0.25rem; border: 1px solid #d1d5db;">
                                Score: ${Math.round(match.score.total)}/100
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function downloadCSV(data, filename) {
            const blob = new Blob([data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadMatches() {
            if (realMatches.length === 0) {
                alert('No matches to download. Please run the matching algorithm first.');
                return;
            }
            
            const csvContent = realMatches.map((match, i) => {
                const pref = match.advisor.preferences.find(p => p.conference === match.conference.Conference);
                return [
                    i + 1,
                    match.advisor.id,
                    match.conference.Conference,
                    match.advisor.totalTTV,
                    pref ? pref.ranking : 'Not ranked',
                    Math.round(match.score.total),
                    match.conference.Location || 'TBD',
                    match.advisor.notes.replace(/,/g, ';') // Replace commas to avoid CSV issues
                ].join(',');
            }).join('\n');
            
            const header = 'Rank,Advisor ID,Conference,TTV,Preference Rank,Match Score,Location,Notes\n';
            downloadCSV(header + csvContent, 'fora_conference_matches_real.csv');
        }

        function downloadEmails() {
            if (realMatches.length === 0) {
                alert('No matches to download. Please run the matching algorithm first.');
                return;
            }
            
            const emailTemplates = realMatches.map((match) => {
                const tier = match.advisor.totalTTV >= 2000000 ? 'Premium ($2M+)' : 
                             match.advisor.totalTTV >= 1000000 ? 'Professional ($1M+)' : 'Rising Star';
                
                const pref = match.advisor.preferences.find(p => p.conference === match.conference.Conference);
                const conference = conferenceDatabase[match.conference.Conference] || {
                    description: `An exclusive conference focused on ${match.conference.Conference}.`,
                    dates: "Dates TBD",
                    location: match.conference.Location || "Location TBD"
                };
                
                const emailBody = `Dear Advisor ${match.advisor.id},

We're excited to assign you to ${match.conference.Conference}!

ABOUT THIS CONFERENCE:
${conference.description}

CONFERENCE DETAILS:
📅 Dates: ${conference.dates}
📍 Location: ${conference.location}

WHY THIS IS PERFECT FOR YOU:
• Your ${tier} status with ${match.advisor.totalTTV.toLocaleString()} TTV qualifies you for this premium event
• ${pref ? `This was your #${pref.ranking} preference choice - excellent alignment!` : 'This conference aligns perfectly with your business focus and expertise'}
• The conference focus matches your expertise and client portfolio
• Excellent networking opportunities with peers in your market segment

NEXT STEPS:
Please confirm your attendance by replying to this email by [CONFIRMATION DEADLINE].
We'll send detailed travel and accommodation information once confirmed.

Looking forward to seeing you there!

Best regards,
The Fora Conference Team`;

                return `${match.advisor.id},"Your Conference Assignment: ${match.conference.Conference}","${emailBody.replace(/"/g, '""')}"`;
            }).join('\n');
            
            const emailHeader = 'Advisor ID,Email Subject,Email Body\n';
            downloadCSV(emailHeader + emailTemplates, 'fora_conference_emails_real.csv');
        }
    </script>
</body>
</html>
