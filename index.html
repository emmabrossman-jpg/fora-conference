<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fora Conference Matching System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Fraunces:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #faf9f7;
            min-height: 100vh;
            padding: 2rem;
            color: #2c2c2c;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            background: linear-gradient(rgba(44, 44, 44, 0.6), rgba(44, 44, 44, 0.6)), url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1200&h=400&fit=crop&crop=center') center/cover;
            padding: 4rem 2rem;
            border: 1px solid #e8e8e8;
            position: relative;
            overflow: hidden;
            color: white;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: serif;
            font-size: 24px;
            font-weight: bold;
            color: #2c2c2c;
            opacity: 0.9;
            z-index: 1;
        }

        .header::after {
            content: 'F';
            position: absolute;
            top: 35px;
            right: 35px;
            font-family: serif;
            font-size: 28px;
            font-weight: bold;
            color: #2c2c2c;
            z-index: 2;
        }

        .header h1 {
            font-size: 2.75rem;
            font-weight: 400;
            color: white;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
            font-style: italic;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.125rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
            font-weight: 300;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .algorithm-section {
            background: #ffffff;
            border: 1px solid #e8e8e8;
            padding: 2.5rem;
            margin-bottom: 2rem;
        }

        .algorithm-section h2 {
            color: #2c2c2c;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 400;
        }

        .algorithm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .algorithm-card {
            background: #faf9f7;
            padding: 2rem;
            border: 1px solid #e8e8e8;
            transition: all 0.3s ease;
        }

        .algorithm-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .algorithm-card h3 {
            color: #2c2c2c;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .scoring-formula {
            background: #f8f8f8;
            border: 1px solid #e8e8e8;
            padding: 1.5rem;
            margin-top: 1.5rem;
            font-family: 'Monaco', 'Consolas', monospace;
            color: #2c2c2c;
            text-align: center;
            font-weight: 500;
        }

        .main-card {
            background: #ffffff;
            border: 1px solid #e8e8e8;
            padding: 2.5rem;
            margin-bottom: 2rem;
        }

        .upload-section {
            text-align: center;
            padding: 3rem;
            border: 2px dashed #cccccc;
            margin-bottom: 2rem;
            background: #faf9f7;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #999999;
            background: #ffffff;
        }

        .upload-button {
            background: #2c2c2c;
            color: white;
            padding: 1rem 2rem;
            border: none;
            font-weight: 400;
            cursor: pointer;
            margin: 1rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.875rem;
        }

        .upload-button:hover {
            background: #1a1a1a;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .process-button {
            background: #2c2c2c;
            color: white;
            padding: 1.25rem 2.5rem;
            border: none;
            font-size: 1.125rem;
            font-weight: 400;
            cursor: pointer;
            display: block;
            margin: 2rem auto;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .process-button:hover {
            background: #1a1a1a;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .process-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .stat-card {
            padding: 2.5rem 2rem;
            text-align: center;
            background: #ffffff;
            border: 1px solid #e8e8e8;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 300;
            margin-bottom: 1rem;
            color: #2c2c2c;
        }

        .stat-label {
            color: #666666;
            font-size: 0.875rem;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .matches-container {
            background: #faf9f7;
            border: 1px solid #e8e8e8;
            padding: 2rem;
            margin: 2rem 0;
            max-height: 500px;
            overflow-y: auto;
        }

        .match-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.75rem;
            background: #ffffff;
            border: 1px solid #e8e8e8;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            border-left: 4px solid #2c2c2c;
        }

        .match-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .advisor-info {
            font-weight: 500;
            color: #2c2c2c;
            font-size: 1.05rem;
        }

        .conference-location {
            color: #666666;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .ttv-info {
            text-align: right;
            font-size: 0.875rem;
        }

        .ttv-amount {
            color: #2c2c2c;
            font-weight: 600;
            font-size: 1rem;
        }

        .preference-rank {
            color: #666666;
            margin: 0.25rem 0;
        }

        .score-badge {
            background: #f8f8f8;
            color: #2c2c2c;
            padding: 0.375rem 0.75rem;
            margin-top: 0.5rem;
            border: 1px solid #e8e8e8;
            display: inline-block;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .download-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 3rem;
        }

        .download-button {
            background: #2c2c2c;
            color: white;
            padding: 1.25rem 1.5rem;
            border: none;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.875rem;
        }

        .download-button:hover {
            background: #1a1a1a;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e8e8e8;
            border-top: 4px solid #2c2c2c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 3rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .conferences-section {
            background: #ffffff;
            border: 1px solid #e8e8e8;
            padding: 2.5rem;
            margin-bottom: 2rem;
        }

        .conferences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .conference-card {
            background: #faf9f7;
            padding: 1.5rem;
            border: 1px solid #e8e8e8;
            transition: all 0.3s ease;
        }

        .conference-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .conference-name {
            font-weight: 500;
            color: #2c2c2c;
            margin-bottom: 0.5rem;
        }

        .conference-details {
            color: #666666;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .stats-grid, .conferences-grid {
                grid-template-columns: 1fr;
            }
            .download-section {
                grid-template-columns: 1fr;
            }
            .match-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Fora Conference Matching System</h1>
            <p>Intelligent advisor-conference optimization platform</p>
        </div>

        <div class="algorithm-section">
            <h2>🧠 How Our Matching Algorithm Works</h2>
            <div class="algorithm-grid">
                <div class="algorithm-card">
                    <h3>Business Priority (40%)</h3>
                    <p>Advisors with higher Total Travel Value (TTV) receive priority placement. This ensures our most valuable advisors get first choice at premium conferences.</p>
                </div>
                <div class="algorithm-card">
                    <h3>Preference Matching (35%)</h3>
                    <p>Your ranked preferences (1-5) are heavily weighted. We prioritize matching you to conferences you specifically requested and ranked highly.</p>
                </div>
                <div class="algorithm-card">
                    <h3>Qualification Requirements (25%)</h3>
                    <p>Geographic TTV thresholds, experience levels, and repeat attendance rules ensure all matches meet conference partner requirements.</p>
                </div>
            </div>
            <div class="scoring-formula">
                Final Score = (Business Priority × 0.4) + (Preference Score × 0.35) + (Qualification Match × 0.25)
            </div>
        </div>

        <div class="conferences-section">
            <h2>📅 2025-2026 Conference Calendar</h2>
            <div class="conferences-grid" id="conferences-list">
                <!-- Conferences will be populated here -->
            </div>
        </div>

        <div class="main-card">
            <div id="upload-step">
                <div class="upload-section">
                    <h3>Upload Advisor Data File</h3>
                    <p>Upload your Excel file containing advisor preferences and TTV data.<br>
                    <small style="color: #666666;">File should have "Sheet1" with advisor data and "Sheet2" with geographic TTV breakdown</small></p>
                    <input type="file" id="file-input" accept=".xlsx,.xls" style="display: none;">
                    <button class="upload-button" onclick="document.getElementById('file-input').click()">
                        Choose Advisor Data File
                    </button>
                    <div style="margin-top: 2rem;">
                        <button onclick="loadSampleData()" class="upload-button" style="background: #666666;">
                            Load Sample Data
                        </button>
                    </div>
                    <div id="file-status"></div>
                </div>
                <button class="process-button" id="process-btn" onclick="runMatching()" disabled>
                    Upload Advisor Data First
                </button>
            </div>

            <div id="processing-step" class="hidden">
                <div style="text-align: center;">
                    <div class="spinner"></div>
                    <h3>Running Matching Algorithm</h3>
                    <p>Analyzing advisors and optimizing conference assignments...</p>
                </div>
            </div>

            <div id="results-step" class="hidden">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 id="results-title">Matches Generated</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="pref-stat">--%</div>
                            <div class="stat-label">Top 3 Preferences</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="ttv-stat">$--M</div>
                            <div class="stat-label">Total TTV Matched</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="qual-stat">--%</div>
                            <div class="stat-label">Eligible Matches</div>
                        </div>
                    </div>
                </div>

                <h3>Your Matches:</h3>
                <div class="matches-container" id="matches-list">
                    <!-- Matches will be populated here -->
                </div>

                <div class="download-section">
                    <button class="download-button" onclick="downloadMatches()">
                        📄 Download Match Results
                    </button>
                    <button class="download-button" onclick="downloadEmails()">
                        📧 Download Email Templates
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let fileData = null;
        let realMatches = [];

        // Complete conference database with all details, requirements, and capacity
        const conferenceDatabase = {
            "DUCO Italy": { 
                location: "Milan, Italy", 
                dates: "Mar 23–27, 2026", 
                description: "A niche, destination-oriented event highlighting the excellence of Italian hospitality. Focuses ONLY on travel products in Italy.",
                capacity: 6,
                requirements: {
                    minTTV: 200000,
                    geoRequirement: "Italy",
                    geoMinTTV: 200000,
                    minExperience: 3,
                    repeatRule: "once every 3 years"
                },
                fee: "$375 EUR registration fee",
                notes: "Hosted stay included, flights at own expense"
            },
            "DUCO France": { 
                location: "Paris, France", 
                dates: "Nov 2–6, 2026", 
                description: "A niche, destination-oriented event highlighting the excellence of French hospitality. Focuses ONLY on travel products in France.",
                capacity: 6,
                requirements: {
                    minTTV: 200000,
                    geoRequirement: "France",
                    geoMinTTV: 200000,
                    minExperience: 3,
                    repeatRule: "once every 3 years"
                },
                fee: "$375 EUR registration fee",
                notes: "Hosted stay included, flights at own expense"
            },
            "DUCO Spain/Portugal": { 
                location: "Marbella, Spain", 
                dates: "Oct 19–23, 2026", 
                description: "A niche, destination-oriented event highlighting Spanish & Portuguese hospitality. Focuses ONLY on travel products in Spain and Portugal.",
                capacity: 2,
                requirements: {
                    minTTV: 200000,
                    geoRequirement: "Spain/Portugal",
                    geoMinTTV: 200000,
                    minExperience: 3,
                    repeatRule: "once every 3 years"
                },
                fee: "$375 EUR registration fee",
                notes: "Hosted stay included, flights at own expense"
            },
            "Emotions Madrid": { 
                location: "Madrid, Spain", 
                dates: "Jun 1–4, 2026", 
                description: "European travel product conference with rich history, scenic capital cities. Great generalist European opportunity.",
                capacity: 6,
                requirements: {},
                notes: "Hosted stay included, flights at own expense"
            },
            "Emotions Latin America & Caribbean": { 
                location: "Buenos Aires, Argentina", 
                dates: "Apr 20–23, 2026", 
                description: "Gathering of exclusive luxury experiences from Latin America and The Caribbean. Great for advisors looking to expand knowledge in these regions.",
                capacity: 4,
                requirements: {},
                notes: "Hosted stay included, flights at own expense"
            },
            "Emotions: Balearics": { 
                location: "Balearic Islands, Spain", 
                dates: "Late Sep/Early Oct 2026", 
                description: "Maestro Event focusing solely on Balearic Islands. Immersive experience for specialists.",
                capacity: 1,
                requirements: {
                    geoRequirement: "Balearics",
                    geoMinPercent: 15
                },
                notes: "Hosted stay included, flights at own expense"
            },
            "Emotions: Greece": { 
                location: "Athens, Greece", 
                dates: "Early Oct 2026", 
                description: "Original Maestro Event focusing solely on Greek exhibitors. Immersive Greek experience for specialists.",
                capacity: 3,
                requirements: {
                    geoRequirement: "Greece",
                    geoMinPercent: 15
                },
                notes: "Hosted stay included, flights at own expense"
            },
            "ILTM Americas": { 
                location: "Baha Mar, Bahamas", 
                dates: "Early Oct 2026", 
                description: "Great first conference! Accessible alternative to Virtuoso Travel Week with same vendors but more low-key atmosphere. Fantastic generalist conference.",
                capacity: 35,
                requirements: {},
                fee: "$250 USD + up to $700 flight reimbursement",
                notes: "Perfect for new advisors building travel knowledge"
            },
            "ILTM Cannes": { 
                location: "Cannes, France", 
                dates: "Dec 1–4, 2025", 
                description: "Flagship ILTM event. World's leading luxury travel trade show with exclusive networking opportunities.",
                capacity: 13,
                requirements: {
                    minTTV: 2000000,
                    minExperience: 1
                },
                fee: "$250 USD",
                notes: "Hosted accommodation, flights at own expense"
            },
            "TRUE Sicily": { 
                location: "Palermo, Sicily", 
                dates: "Nov 2026", 
                description: "Invitation-only luxury trade show for authentic, high-end Sicilian hospitality brands. Regional focus only.",
                capacity: 10,
                requirements: {
                    geoRequirement: "Italy/Sicily"
                },
                notes: "Hosted stay included, optional pre/post FAMs available"
            },
            "TRUE Dolomites": { 
                location: "Alta Badia, Dolomites", 
                dates: "Jun 2026", 
                description: "Invitation-only luxury trade show for Dolomites and surrounding areas. Regional mountain luxury focus.",
                capacity: 10,
                requirements: {
                    geoRequirement: "Italy/Dolomites"
                },
                notes: "Hosted stay included, optional pre/post FAMs available"
            },
            "TRUE Puglia": { 
                location: "Puglia, Italy", 
                dates: "Apr 13–16, 2026", 
                description: "Invitation-only luxury trade show for Puglia and South Italy. Regional focus on authentic hospitality brands.",
                capacity: 10,
                requirements: {
                    geoRequirement: "Italy/Puglia"
                },
                notes: "Hosted stay included, optional pre/post FAMs available"
            },
            "We Are Africa": { 
                location: "Cape Town, South Africa", 
                dates: "May 4–8, 2026", 
                description: "World's most vibrant gathering of luxury African travel brands. For advisors already selling Africa at high level - requires 3 supplier references.",
                capacity: 5,
                requirements: {
                    geoRequirement: "Africa",
                    supplierReferences: 3
                },
                fee: "249 GBP commitment fee",
                notes: "Not for beginners - enhances existing Africa knowledge"
            },
            "We Are Africa Sundance": { 
                location: "Sundance Mountain Resort, Utah", 
                dates: "Early Oct 2026", 
                description: "Stateside edition for advisors with established business wanting to book Africa. Combines thought-leadership with business meetings.",
                capacity: 4,
                requirements: {
                    establishedBusiness: true
                },
                fee: "699 GBP plus flights",
                notes: "Good for advisors new to Africa with established client base"
            },
            "LE Miami": { 
                location: "Miami, Florida", 
                dates: "Jun 1–4, 2026", 
                description: "Lifestyle and hotel, high-end contemporary travel conference. Forward-thinking, senior-level buyers for creative class travelers.",
                capacity: 10,
                requirements: {
                    minTTV: 1000000,
                    supplierReferences: 3
                },
                notes: "Fun conference with lots of content. Global reach focus."
            },
            "PURE Life Experiences": { 
                location: "Marrakech, Morocco", 
                dates: "Sep 8–11, 2026", 
                description: "World's leading experiential travel show. Exceptional generalist conference for advisors operating at the highest level.",
                capacity: 4,
                requirements: {
                    supplierReferences: 3,
                    highEndExperiential: true,
                    notAttendedRecently: "3 years"
                },
                fee: "429 GBP plus flights",
                notes: "For top agents selling high-end experiential travel globally"
            },
            "Do Not Disturb": { 
                location: "Puglia, Italy", 
                dates: "Nov 10–14, 2026", 
                description: "Global private travel community for Ultra High Net Worth clients. Focus on space, seclusion, and sustainability.",
                capacity: 4,
                requirements: {
                    clientType: "UHNW",
                    privateExclusive: true
                },
                notes: "Deep dive conference with fewer, longer meetings"
            },
            "Further East": { 
                location: "Seminyak, Bali", 
                dates: "Early Nov 2026", 
                description: "APAC's most innovative high-end travel trade show. Four-day ideas festival focused on future of APAC luxury travel.",
                capacity: 4,
                requirements: {
                    geoRequirement: "Asia-Pacific"
                },
                notes: "Exceptional opportunity for Asia-focused advisors"
            },
            "Remote Immersion": { 
                location: "Boquete, Panama", 
                dates: "May 4–8, 2026", 
                description: "Community bringing together creative Latin America hoteliers with innovative travel designers. Adventure-focused, not luxury oriented.",
                capacity: 6,
                requirements: {
                    geoRequirement: "Latin America",
                    adventureFocus: true
                },
                notes: "Immersive adventure experience, good existing Latin America knowledge helpful"
            }
        };

        // Populate conferences section
        function populateConferences() {
            const conferencesList = document.getElementById('conferences-list');
            const sortedConferences = Object.entries(conferenceDatabase).sort((a, b) => {
                // Sort by date
                const dateA = new Date(a[1].dates.split('–')[0] + ', 2026');
                const dateB = new Date(b[1].dates.split('–')[0] + ', 2026');
                return dateA - dateB;
            });

            conferencesList.innerHTML = sortedConferences.map(([name, details]) => `
                <div class="conference-card">
                    <div class="conference-name">${name} (${details.capacity} spots)</div>
                    <div class="conference-details">
                        <div style="margin-bottom: 0.5rem;"><strong>📅 ${details.dates}</strong></div>
                        <div style="margin-bottom: 0.5rem;"><strong>📍 ${details.location}</strong></div>
                        <div style="margin-bottom: 0.5rem;">${details.description}</div>
                        ${details.fee ? `<div style="margin-bottom: 0.5rem; color: #059669;"><strong>💰 ${details.fee}</strong></div>` : ''}
                        ${Object.keys(details.requirements || {}).length > 0 ? 
                            `<div style="margin-top: 0.5rem; font-size: 0.8rem; color: #dc2626;">
                                <strong>Requirements:</strong> 
                                ${details.requirements.minTTV ? `$${(details.requirements.minTTV/1000).toFixed(0)}K+ TTV` : ''}
                                ${details.requirements.geoRequirement ? `, ${details.requirements.geoRequirement} focus` : ''}
                                ${details.requirements.geoMinPercent ? `, ${details.requirements.geoMinPercent}% regional business` : ''}
                            </div>` : ''
                        }
                    </div>
                </div>
            `).join('');
        }

        // Load sample data function
        function loadSampleData() {
            // Create sample advisor data with realistic conference preferences
            const sampleAdvisors = [
                { id: 3045, preferences: [{conference: 'ILTM Cannes', ranking: 1}, {conference: 'LE Miami', ranking: 2}, {conference: 'DUCO France', ranking: 3}], previousConference: null, notes: 'Luxury specialist with strong European network. 5+ years experience.', totalTTV: 4078938 },
                { id: 2463, preferences: [{conference: 'ILTM Americas', ranking: 1}, {conference: 'DUCO Italy', ranking: 2}, {conference: 'LE Miami', ranking: 3}], previousConference: null, notes: 'High-volume Americas advisor with established Italian client base.', totalTTV: 3449979 },
                { id: 6841, preferences: [{conference: 'LE Miami', ranking: 1}, {conference: 'Do Not Disturb', ranking: 2}, {conference: 'ILTM Cannes', ranking: 3}], previousConference: 'ILTM Americas', notes: 'Strong luxury leisure focus with UHNW clients.', totalTTV: 2657344 },
                { id: 9236, preferences: [{conference: 'LE Miami', ranking: 1}, {conference: 'ILTM Cannes', ranking: 2}], previousConference: null, notes: 'Can\'t travel Feb-June due to family commitments. LE is only first half conference I can attend.', totalTTV: 1753868 },
                { id: 11508, preferences: [{conference: 'ILTM Cannes', ranking: 1}, {conference: 'ILTM Americas', ranking: 2}, {conference: 'PURE Life Experiences', ranking: 3}], previousConference: null, notes: 'European specialist with luxury focus and experiential expertise.', totalTTV: 2845192 },
                { id: 8394, preferences: [{conference: 'Do Not Disturb', ranking: 1}, {conference: 'Emotions Madrid', ranking: 2}], previousConference: null, notes: 'Wellness and retreat specialist with UHNW private travel expertise.', totalTTV: 1892456 },
                { id: 5750, preferences: [{conference: 'Emotions Madrid', ranking: 1}, {conference: 'LE Miami', ranking: 2}, {conference: 'DUCO Spain/Portugal', ranking: 3}], previousConference: null, notes: 'European market focus with strong Spanish/Portuguese expertise.', totalTTV: 1634729 },
                { id: 7821, preferences: [{conference: 'ILTM Americas', ranking: 1}, {conference: 'We Are Africa', ranking: 2}], previousConference: null, notes: 'Americas regional specialist with emerging Africa interest.', totalTTV: 1567843 },
                { id: 4392, preferences: [{conference: 'We Are Africa', ranking: 1}, {conference: 'ILTM Americas', ranking: 2}, {conference: 'We Are Africa Sundance', ranking: 3}], previousConference: null, notes: 'Established advisor wanting to expand into African market.', totalTTV: 1438291 },
                { id: 6321, preferences: [{conference: 'Further East', ranking: 1}, {conference: 'ILTM Americas', ranking: 2}], previousConference: null, notes: 'Asia-Pacific specialist focusing on luxury APAC experiences.', totalTTV: 1329847 }
            ];

            // Sample geographic TTV data to test requirements
            const sampleGeoTTV = {
                3045: { "France": 800000, "Italy": 300000, "Spain": 200000 },
                2463: { "Italy": 650000, "Spain": 400000, "Portugal": 150000 },
                6841: { "France": 400000, "Italy": 300000 },
                5750: { "Spain": 450000, "Portugal": 250000, "Italy": 200000 },
                8394: { "Italy": 300000, "Spain": 200000 },
                6321: { "Asia": 800000, "Japan": 300000, "Thailand": 200000 }
            };

            const sampleTTV = {};
            sampleAdvisors.forEach(advisor => {
                sampleTTV[advisor.id] = advisor.totalTTV;
            });

            fileData = {
                advisors: sampleAdvisors,
                ttv: sampleTTV,
                geo: sampleGeoTTV,
                conferences: []
            };

            // Enable processing
            const processBtn = document.getElementById('process-btn');
            processBtn.disabled = false;
            processBtn.textContent = 'Generate Sample Matches';
            processBtn.style.background = '#2c2c2c';

            document.getElementById('file-status').innerHTML = `
                <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 1.25rem; margin-top: 1rem; border: 1px solid #10b981;">
                    <p style="color: #065f46; font-weight: 500;">Sample data loaded successfully!</p>
                    <p style="color: #047857; font-size: 0.875rem; margin-top: 0.5rem;">10 advisors with preferences and TTV data ready for matching</p>
                </div>
            `;
        }

        // File upload handler
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Process the consolidated advisor data from Sheet1
                    const advisorSheet = workbook.Sheets['Sheet1'] || workbook.Sheets['Advisor Preferences'];
                    if (!advisorSheet) {
                        throw new Error('Could not find advisor data sheet. Please ensure your file has either "Sheet1" or "Advisor Preferences" sheet.');
                    }
                    
                    const rawAdvisorData = XLSX.utils.sheet_to_json(advisorSheet, { header: 1 });
                    const headers = rawAdvisorData[0];
                    const advisorRows = rawAdvisorData.slice(1);

                    // Find the TTV column (should be last column with TTV data)
                    const ttvColumnIndex = headers.findIndex(header => 
                        header && header.toString().toLowerCase().includes('ttv')
                    ) || headers.length - 1;

                    const advisors = advisorRows.map(row => {
                        // Skip rows with missing advisor ID
                        if (!row[0]) return null;
                        
                        const advisor = {
                            id: row[0],
                            previousConference: row[1] === 'None!' ? null : row[1],
                            preferences: [],
                            notes: row[24] || '', // Notes column
                            totalTTV: row[ttvColumnIndex] || 0
                        };
                        
                        // Handle previousConference data type issues
                        if (advisor.previousConference !== null) {
                            if (typeof advisor.previousConference === 'number') {
                                advisor.previousConference = advisor.previousConference.toString();
                            } else if (typeof advisor.previousConference === 'undefined') {
                                advisor.previousConference = null;
                            }
                        }
                        
                        // Process conference preference rankings (columns 2-21)
                        const conferenceColumns = headers.slice(2, 22);
                        conferenceColumns.forEach((confName, index) => {
                            const ranking = row[2 + index];
                            if (typeof ranking === 'number' && ranking >= 1 && ranking <= 5) {
                                advisor.preferences.push({
                                    conference: confName,
                                    ranking: ranking
                                });
                            }
                        });
                        
                        advisor.preferences.sort((a, b) => a.ranking - b.ranking);
                        return advisor;
                    }).filter(advisor => advisor !== null);

                    // Build TTV map from the consolidated data
                    const ttvMap = {};
                    advisors.forEach(advisor => {
                        if (advisor.id && advisor.totalTTV) {
                            ttvMap[advisor.id] = advisor.totalTTV;
                        }
                    });

                    // Process geo data from Sheet2
                    const geoSheet = workbook.Sheets['Sheet2'] || workbook.Sheets['Geo Values'];
                    const geoRows = geoSheet ? XLSX.utils.sheet_to_json(geoSheet) : [];
                    const geoMap = {};
                    geoRows.forEach(row => {
                        const advisorId = row['Advisor ID'];
                        if (advisorId) {
                            if (!geoMap[advisorId]) geoMap[advisorId] = {};
                            const country = row.Country;
                            const value = row['Commissionable Booking Value'] || 0;
                            if (!geoMap[advisorId][country]) geoMap[advisorId][country] = 0;
                            geoMap[advisorId][country] += value;
                        }
                    });

                    fileData = {
                        advisors: advisors,
                        ttv: ttvMap,
                        geo: geoMap,
                        conferences: []
                    };

                    // Enable processing
                    const processBtn = document.getElementById('process-btn');
                    processBtn.disabled = false;
                    processBtn.textContent = 'Generate Matches';
                    processBtn.style.background = '#2c2c2c';

                    document.getElementById('file-status').innerHTML = `
                        <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 1.25rem; margin-top: 1rem; border: 1px solid #10b981;">
                            <p style="color: #065f46; font-weight: 500;">File processed successfully!</p>
                            <p style="color: #047857; font-size: 0.875rem; margin-top: 0.5rem;">${fileData.advisors.length} advisors with ${Object.keys(fileData.ttv).length} TTV records</p>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('file-status').innerHTML = `
                        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 1.25rem; margin-top: 1rem; border: 1px solid #dc2626;">
                            <p style="color: #dc2626; font-weight: 500;">Error reading file: ${error.message}</p>
                        </div>
                    `;
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function runMatching() {
            if (!fileData) {
                alert('Please upload data first');
                return;
            }

            document.getElementById('upload-step').classList.add('hidden');
            document.getElementById('processing-step').classList.remove('hidden');

            setTimeout(() => {
                try {
                    realMatches = generateMatches();
                    showResults();
                } catch (error) {
                    console.error('Matching error:', error);
                    alert('Error running matching: ' + error.message);
                }
            }, 2000);
        }

        function generateMatches() {
            const enrichedAdvisors = fileData.advisors
                .filter(advisor => advisor.id && fileData.ttv[advisor.id] && advisor.preferences.length > 0)
                .map(advisor => ({
                    ...advisor,
                    totalTTV: fileData.ttv[advisor.id] || 0,
                    geoTTV: fileData.geo[advisor.id] || {}
                }))
                .sort((a, b) => b.totalTTV - a.totalTTV);

            // Initialize conference capacities from database
            const conferenceCapacity = {};
            const requestedConferences = new Set();
            enrichedAdvisors.forEach(advisor => {
                advisor.preferences.forEach(pref => {
                    requestedConferences.add(pref.conference);
                });
            });

            requestedConferences.forEach(confName => {
                const confData = conferenceDatabase[confName];
                conferenceCapacity[confName] = confData ? confData.capacity : 6; // Use database capacity or default
            });

            const matches = [];

            for (const advisor of enrichedAdvisors) {
                let bestMatch = null;
                let bestScore = -1;

                for (const preference of advisor.preferences) {
                    const confName = preference.conference;
                    
                    if (conferenceCapacity[confName] <= 0) continue;

                    const conference = {
                        Conference: confName,
                        Location: conferenceDatabase[confName]?.location || 'Location TBD',
                        Dates: conferenceDatabase[confName]?.dates || 'Dates TBD'
                    };

                    const eligibility = checkEligibility(advisor, conference);
                    if (!eligibility.eligible) continue;

                    const businessScore = Math.min(advisor.totalTTV / 2000000, 1.0) * 100 * 0.4;
                    const preferenceScore = (6 - preference.ranking) * 20 * 0.35;
                    const qualificationScore = 100 * 0.25;
                    const totalScore = businessScore + preferenceScore + qualificationScore;

                    if (totalScore > bestScore) {
                        bestMatch = {
                            advisor,
                            conference,
                            preferenceRank: preference.ranking,
                            score: {
                                total: totalScore,
                                business: businessScore,
                                preference: preferenceScore,
                                qualification: qualificationScore,
                                eligible: true
                            }
                        };
                        bestScore = totalScore;
                    }
                }

                if (bestMatch) {
                    matches.push(bestMatch);
                    conferenceCapacity[bestMatch.conference.Conference]--;
                }
            }

            return matches;
        }

        function checkEligibility(advisor, conference) {
            const conf = conference.Conference;
            const confData = conferenceDatabase[conf];
            
            if (!confData) {
                return { eligible: false, reason: 'Conference not found in database' };
            }

            // Check repeat attendance - ensure previousConference exists and is a string
            if (advisor.previousConference && 
                typeof advisor.previousConference === 'string' && 
                advisor.previousConference !== 'None!' && 
                advisor.previousConference.toLowerCase() !== 'none') {
                
                const prevConf = advisor.previousConference.toLowerCase();
                const currentConf = conf.toLowerCase();
                
                // Exact same conference
                if (prevConf === currentConf) {
                    return { eligible: false, reason: 'Attended same conference last year' };
                }
                
                // Conference family restrictions
                if (prevConf.includes('duco') && currentConf.includes('duco')) {
                    return { eligible: false, reason: 'Attended DUCO family conference last year' };
                }
                if (prevConf.includes('iltm') && currentConf.includes('iltm')) {
                    return { eligible: false, reason: 'Attended ILTM family conference last year' };
                }
                if (prevConf.includes('emotions') && currentConf.includes('emotions')) {
                    return { eligible: false, reason: 'Attended Emotions family conference last year' };
                }
                if (prevConf.includes('true') && currentConf.includes('true')) {
                    return { eligible: false, reason: 'Attended TRUE family conference last year' };
                }
                if (prevConf.includes('we are africa') && currentConf.includes('we are africa')) {
                    return { eligible: false, reason: 'Attended We Are Africa family conference last year' };
                }
            }

            const requirements = confData.requirements || {};

            // Check minimum TTV requirements
            if (requirements.minTTV && advisor.totalTTV < requirements.minTTV) {
                return { 
                    eligible: false, 
                    reason: `Total TTV: ${advisor.totalTTV.toLocaleString()} < ${requirements.minTTV.toLocaleString()} required` 
                };
            }

            // Check geographic TTV requirements
            if (requirements.geoRequirement && requirements.geoMinTTV) {
                const geoTTV = advisor.geoTTV[requirements.geoRequirement] || 0;
                if (geoTTV < requirements.geoMinTTV) {
                    return { 
                        eligible: false, 
                        reason: `${requirements.geoRequirement} TTV: ${geoTTV.toLocaleString()} < ${requirements.geoMinTTV.toLocaleString()} required` 
                    };
                }
            }

            // Check geographic percentage requirements (for Emotions Maestro events)
            if (requirements.geoRequirement && requirements.geoMinPercent) {
                const geoTTV = advisor.geoTTV[requirements.geoRequirement] || 0;
                const geoPercent = advisor.totalTTV > 0 ? (geoTTV / advisor.totalTTV) * 100 : 0;
                if (geoPercent < requirements.geoMinPercent) {
                    return { 
                        eligible: false, 
                        reason: `${requirements.geoRequirement} business: ${geoPercent.toFixed(1)}% < ${requirements.geoMinPercent}% required` 
                    };
                }
            }

            return { eligible: true, reason: 'Qualified' };
        }

        function showResults() {
            document.getElementById('processing-step').classList.add('hidden');
            document.getElementById('results-step').classList.remove('hidden');

            // Update stats
            const totalTTV = realMatches.reduce((sum, match) => sum + match.advisor.totalTTV, 0);
            const topPrefCount = realMatches.filter(match => match.preferenceRank <= 3).length;

            document.getElementById('results-title').textContent = `${realMatches.length} Matches Generated`;
            document.getElementById('pref-stat').textContent = realMatches.length > 0 ? `${Math.round((topPrefCount / realMatches.length) * 100)}%` : '0%';
            document.getElementById('ttv-stat').textContent = `${Math.round(totalTTV / 1000000)}M`;
            document.getElementById('qual-stat').textContent = '100%';

            // Populate matches
            const matchesList = document.getElementById('matches-list');
            matchesList.innerHTML = realMatches.map((match, i) => `
                <div class="match-item">
                    <div style="flex: 1;">
                        <div class="advisor-info">👤 #${i + 1} Advisor ${match.advisor.id} → ${match.conference.Conference}</div>
                        <div class="conference-location">${match.conference.Location} • ${match.conference.Dates}</div>
                        ${match.advisor.notes ? `<div style="color: #666666; font-size: 0.875rem; margin-top: 0.75rem; line-height: 1.4; padding: 0.75rem; background: #f8f8f8; border-left: 3px solid #2c2c2c;"><strong>Notes:</strong> ${match.advisor.notes}</div>` : ''}
                    </div>
                    <div class="ttv-info">
                        <div class="ttv-amount">${match.advisor.totalTTV.toLocaleString()}</div>
                        <div class="preference-rank">#${match.preferenceRank} preference</div>
                        <div class="score-badge">Score: ${Math.round(match.score.total)}/100</div>
                    </div>
                </div>
            `).join('');
        }

        function downloadMatches() {
            if (realMatches.length === 0) return;

            const csvContent = realMatches.map((match, i) => 
                [i + 1, match.advisor.id, match.conference.Conference, match.advisor.totalTTV, match.preferenceRank, Math.round(match.score.total), match.conference.Location, match.conference.Dates, `"${match.advisor.notes.replace(/"/g, '""')}"`].join(',')
            ).join('\n');

            const header = 'Rank,Advisor ID,Conference,TTV,Preference Rank,Match Score,Location,Dates,Notes\n';
            downloadCSV(header + csvContent, 'fora_conference_matches.csv');
        }

        function downloadEmails() {
            if (realMatches.length === 0) return;

            const emailTemplates = realMatches.map((match) => {
                const tier = match.advisor.totalTTV >= 2000000 ? 'Premium ($2M+)' : 
                             match.advisor.totalTTV >= 1000000 ? 'Professional ($1M+)' : 'Rising Star';
                
                const conference = conferenceDatabase[match.conference.Conference] || {
                    description: `An exclusive conference focused on ${match.conference.Conference}.`,
                    dates: match.conference.Dates,
                    location: match.conference.Location
                };
                
                const emailBody = `Dear Advisor ${match.advisor.id},

We're excited to assign you to ${match.conference.Conference}!

ABOUT THIS CONFERENCE:
${conference.description}

CONFERENCE DETAILS:
📅 Dates: ${conference.dates}
📍 Location: ${conference.location}

WHY THIS IS PERFECT FOR YOU:
• Your ${tier} status with ${match.advisor.totalTTV.toLocaleString()} TTV qualifies you for this premium event
• This was your #${match.preferenceRank} preference choice - excellent alignment!
• The conference focus matches your expertise and client portfolio
• Excellent networking opportunities with peers in your market segment

NEXT STEPS:
Please confirm your attendance by replying to this email by [CONFIRMATION DEADLINE].
We'll send detailed travel and accommodation information once confirmed.

Looking forward to seeing you there!

Best regards,
The Fora Conference Team`;

                return `${match.advisor.id},"Your Conference Assignment: ${match.conference.Conference}","${emailBody.replace(/"/g, '""')}"`;
            }).join('\n');
            
            const emailHeader = 'Advisor ID,Email Subject,Email Body\n';
            downloadCSV(emailHeader + emailTemplates, 'fora_conference_emails.csv');
        }

        function downloadCSV(data, filename) {
            const blob = new Blob([data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize conferences section on page load
        populateConferences();
    </script>
</body>
</html> 
